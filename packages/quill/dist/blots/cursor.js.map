{"version":3,"file":"cursor.js","names":["EmbedBlot","Scope","TextBlot","Cursor","blotName","className","tagName","CONTENTS","value","undefined","constructor","scroll","domNode","selection","textNode","document","createTextNode","appendChild","savedLength","detach","parent","removeChild","format","name","target","index","statics","scope","BLOCK_BLOT","offset","length","optimize","formatAt","node","position","data","remove","restore","composing","range","getNativeRange","lastChild","parentNode","insertBefore","prevTextBlot","prev","prevTextLength","nextTextBlot","next","nextText","text","newText","split","join","mergedTextBlot","insertAt","newTextNode","create","remapOffset","start","end","startNode","startOffset","endNode","endOffset","update","mutations","context","some","mutation","type","isolate","unwrap"],"sources":["../../src/blots/cursor.ts"],"sourcesContent":["import { EmbedBlot, Scope } from 'parchment';\r\nimport type { Parent, ScrollBlot } from 'parchment';\r\nimport type Selection from '../core/selection.js';\r\nimport TextBlot from './text.js';\r\nimport type { EmbedContextRange } from './embed.js';\r\n\r\nclass Cursor extends EmbedBlot {\r\n  static blotName = 'cursor';\r\n  static className = 'ql-cursor';\r\n  static tagName = 'span';\r\n  static CONTENTS = '\\uFEFF'; // Zero width no break space\r\n\r\n  static value() {\r\n    return undefined;\r\n  }\r\n\r\n  selection: Selection;\r\n  textNode: Text;\r\n  savedLength: number;\r\n\r\n  constructor(scroll: ScrollBlot, domNode: HTMLElement, selection: Selection) {\r\n    super(scroll, domNode);\r\n    this.selection = selection;\r\n    this.textNode = document.createTextNode(Cursor.CONTENTS);\r\n    this.domNode.appendChild(this.textNode);\r\n    this.savedLength = 0;\r\n  }\r\n\r\n  detach() {\r\n    // super.detach() will also clear domNode.__blot\r\n    if (this.parent != null) this.parent.removeChild(this);\r\n  }\r\n\r\n  format(name: string, value: unknown) {\r\n    if (this.savedLength !== 0) {\r\n      super.format(name, value);\r\n      return;\r\n    }\r\n    // TODO: Fix this next time the file is edited.\r\n    // eslint-disable-next-line @typescript-eslint/no-this-alias\r\n    let target: Parent | this = this;\r\n    let index = 0;\r\n    while (target != null && target.statics.scope !== Scope.BLOCK_BLOT) {\r\n      index += target.offset(target.parent);\r\n      target = target.parent;\r\n    }\r\n    if (target != null) {\r\n      this.savedLength = Cursor.CONTENTS.length;\r\n      // @ts-expect-error TODO: allow empty context in Parchment\r\n      target.optimize();\r\n      target.formatAt(index, Cursor.CONTENTS.length, name, value);\r\n      this.savedLength = 0;\r\n    }\r\n  }\r\n\r\n  index(node: Node, offset: number) {\r\n    if (node === this.textNode) return 0;\r\n    return super.index(node, offset);\r\n  }\r\n\r\n  length() {\r\n    return this.savedLength;\r\n  }\r\n\r\n  position(): [Text, number] {\r\n    return [this.textNode, this.textNode.data.length];\r\n  }\r\n\r\n  remove() {\r\n    super.remove();\r\n    // @ts-expect-error Fix me later\r\n    this.parent = null;\r\n  }\r\n\r\n  restore(): EmbedContextRange | null {\r\n    if (this.selection.composing || this.parent == null) return null;\r\n    const range = this.selection.getNativeRange();\r\n    // Browser may push down styles/nodes inside the cursor blot.\r\n    // https://dvcs.w3.org/hg/editing/raw-file/tip/editing.html#push-down-values\r\n    while (\r\n      this.domNode.lastChild != null &&\r\n      this.domNode.lastChild !== this.textNode\r\n    ) {\r\n      // @ts-expect-error Fix me later\r\n      this.domNode.parentNode.insertBefore(\r\n        this.domNode.lastChild,\r\n        this.domNode,\r\n      );\r\n    }\r\n\r\n    const prevTextBlot = this.prev instanceof TextBlot ? this.prev : null;\r\n    const prevTextLength = prevTextBlot ? prevTextBlot.length() : 0;\r\n    const nextTextBlot = this.next instanceof TextBlot ? this.next : null;\r\n    // @ts-expect-error TODO: make TextBlot.text public\r\n    const nextText = nextTextBlot ? nextTextBlot.text : '';\r\n    const { textNode } = this;\r\n    // take text from inside this blot and reset it\r\n    const newText = textNode.data.split(Cursor.CONTENTS).join('');\r\n    textNode.data = Cursor.CONTENTS;\r\n\r\n    // proactively merge TextBlots around cursor so that optimization\r\n    // doesn't lose the cursor.  the reason we are here in cursor.restore\r\n    // could be that the user clicked in prevTextBlot or nextTextBlot, or\r\n    // the user typed something.\r\n    let mergedTextBlot;\r\n    if (prevTextBlot) {\r\n      mergedTextBlot = prevTextBlot;\r\n      if (newText || nextTextBlot) {\r\n        prevTextBlot.insertAt(prevTextBlot.length(), newText + nextText);\r\n        if (nextTextBlot) {\r\n          nextTextBlot.remove();\r\n        }\r\n      }\r\n    } else if (nextTextBlot) {\r\n      mergedTextBlot = nextTextBlot;\r\n      nextTextBlot.insertAt(0, newText);\r\n    } else {\r\n      const newTextNode = document.createTextNode(newText);\r\n      mergedTextBlot = this.scroll.create(newTextNode);\r\n      this.parent.insertBefore(mergedTextBlot, this);\r\n    }\r\n\r\n    this.remove();\r\n    if (range) {\r\n      // calculate selection to restore\r\n      const remapOffset = (node: Node, offset: number) => {\r\n        if (prevTextBlot && node === prevTextBlot.domNode) {\r\n          return offset;\r\n        }\r\n        if (node === textNode) {\r\n          return prevTextLength + offset - 1;\r\n        }\r\n        if (nextTextBlot && node === nextTextBlot.domNode) {\r\n          return prevTextLength + newText.length + offset;\r\n        }\r\n        return null;\r\n      };\r\n\r\n      const start = remapOffset(range.start.node, range.start.offset);\r\n      const end = remapOffset(range.end.node, range.end.offset);\r\n      if (start !== null && end !== null) {\r\n        return {\r\n          startNode: mergedTextBlot.domNode,\r\n          startOffset: start,\r\n          endNode: mergedTextBlot.domNode,\r\n          endOffset: end,\r\n        };\r\n      }\r\n    }\r\n    return null;\r\n  }\r\n\r\n  update(mutations: MutationRecord[], context: Record<string, unknown>) {\r\n    if (\r\n      mutations.some((mutation) => {\r\n        return (\r\n          mutation.type === 'characterData' && mutation.target === this.textNode\r\n        );\r\n      })\r\n    ) {\r\n      const range = this.restore();\r\n      if (range) context.range = range;\r\n    }\r\n  }\r\n\r\n  // Avoid .ql-cursor being a descendant of `<a/>`.\r\n  // The reason is Safari pushes down `<a/>` on text insertion.\r\n  // That will cause DOM nodes not sync with the model.\r\n  //\r\n  // For example ({I} is the caret), given the markup:\r\n  //    <a><span class=\"ql-cursor\">\\uFEFF{I}</span></a>\r\n  // When typing a char \"x\", `<a/>` will be pushed down inside the `<span>` first:\r\n  //    <span class=\"ql-cursor\"><a>\\uFEFF{I}</a></span>\r\n  // And then \"x\" will be inserted after `<a/>`:\r\n  //    <span class=\"ql-cursor\"><a>\\uFEFF</a>d{I}</span>\r\n  optimize(context?: unknown) {\r\n    // @ts-expect-error Fix me later\r\n    super.optimize(context);\r\n\r\n    let { parent } = this;\r\n    while (parent) {\r\n      if (parent.domNode.tagName === 'A') {\r\n        this.savedLength = Cursor.CONTENTS.length;\r\n        // @ts-expect-error TODO: make isolate generic\r\n        parent.isolate(this.offset(parent), this.length()).unwrap();\r\n        this.savedLength = 0;\r\n        break;\r\n      }\r\n      parent = parent.parent;\r\n    }\r\n  }\r\n\r\n  value() {\r\n    return '';\r\n  }\r\n}\r\n\r\nexport default Cursor;\r\n"],"mappings":"AAAA,SAASA,SAAS,EAAEC,KAAK,QAAQ,WAAW;AAG5C,OAAOC,QAAQ,MAAM,WAAW;AAGhC,MAAMC,MAAM,SAASH,SAAS,CAAC;EAC7B,OAAOI,QAAQ,GAAG,QAAQ;EAC1B,OAAOC,SAAS,GAAG,WAAW;EAC9B,OAAOC,OAAO,GAAG,MAAM;EACvB,OAAOC,QAAQ,GAAG,QAAQ,CAAC,CAAC;;EAE5B,OAAOC,KAAKA,CAAA,EAAG;IACb,OAAOC,SAAS;EAClB;EAMAC,WAAWA,CAACC,MAAkB,EAAEC,OAAoB,EAAEC,SAAoB,EAAE;IAC1E,KAAK,CAACF,MAAM,EAAEC,OAAO,CAAC;IACtB,IAAI,CAACC,SAAS,GAAGA,SAAS;IAC1B,IAAI,CAACC,QAAQ,GAAGC,QAAQ,CAACC,cAAc,CAACb,MAAM,CAACI,QAAQ,CAAC;IACxD,IAAI,CAACK,OAAO,CAACK,WAAW,CAAC,IAAI,CAACH,QAAQ,CAAC;IACvC,IAAI,CAACI,WAAW,GAAG,CAAC;EACtB;EAEAC,MAAMA,CAAA,EAAG;IACP;IACA,IAAI,IAAI,CAACC,MAAM,IAAI,IAAI,EAAE,IAAI,CAACA,MAAM,CAACC,WAAW,CAAC,IAAI,CAAC;EACxD;EAEAC,MAAMA,CAACC,IAAY,EAAEf,KAAc,EAAE;IACnC,IAAI,IAAI,CAACU,WAAW,KAAK,CAAC,EAAE;MAC1B,KAAK,CAACI,MAAM,CAACC,IAAI,EAAEf,KAAK,CAAC;MACzB;IACF;IACA;IACA;IACA,IAAIgB,MAAqB,GAAG,IAAI;IAChC,IAAIC,KAAK,GAAG,CAAC;IACb,OAAOD,MAAM,IAAI,IAAI,IAAIA,MAAM,CAACE,OAAO,CAACC,KAAK,KAAK1B,KAAK,CAAC2B,UAAU,EAAE;MAClEH,KAAK,IAAID,MAAM,CAACK,MAAM,CAACL,MAAM,CAACJ,MAAM,CAAC;MACrCI,MAAM,GAAGA,MAAM,CAACJ,MAAM;IACxB;IACA,IAAII,MAAM,IAAI,IAAI,EAAE;MAClB,IAAI,CAACN,WAAW,GAAGf,MAAM,CAACI,QAAQ,CAACuB,MAAM;MACzC;MACAN,MAAM,CAACO,QAAQ,CAAC,CAAC;MACjBP,MAAM,CAACQ,QAAQ,CAACP,KAAK,EAAEtB,MAAM,CAACI,QAAQ,CAACuB,MAAM,EAAEP,IAAI,EAAEf,KAAK,CAAC;MAC3D,IAAI,CAACU,WAAW,GAAG,CAAC;IACtB;EACF;EAEAO,KAAKA,CAACQ,IAAU,EAAEJ,MAAc,EAAE;IAChC,IAAII,IAAI,KAAK,IAAI,CAACnB,QAAQ,EAAE,OAAO,CAAC;IACpC,OAAO,KAAK,CAACW,KAAK,CAACQ,IAAI,EAAEJ,MAAM,CAAC;EAClC;EAEAC,MAAMA,CAAA,EAAG;IACP,OAAO,IAAI,CAACZ,WAAW;EACzB;EAEAgB,QAAQA,CAAA,EAAmB;IACzB,OAAO,CAAC,IAAI,CAACpB,QAAQ,EAAE,IAAI,CAACA,QAAQ,CAACqB,IAAI,CAACL,MAAM,CAAC;EACnD;EAEAM,MAAMA,CAAA,EAAG;IACP,KAAK,CAACA,MAAM,CAAC,CAAC;IACd;IACA,IAAI,CAAChB,MAAM,GAAG,IAAI;EACpB;EAEAiB,OAAOA,CAAA,EAA6B;IAClC,IAAI,IAAI,CAACxB,SAAS,CAACyB,SAAS,IAAI,IAAI,CAAClB,MAAM,IAAI,IAAI,EAAE,OAAO,IAAI;IAChE,MAAMmB,KAAK,GAAG,IAAI,CAAC1B,SAAS,CAAC2B,cAAc,CAAC,CAAC;IAC7C;IACA;IACA,OACE,IAAI,CAAC5B,OAAO,CAAC6B,SAAS,IAAI,IAAI,IAC9B,IAAI,CAAC7B,OAAO,CAAC6B,SAAS,KAAK,IAAI,CAAC3B,QAAQ,EACxC;MACA;MACA,IAAI,CAACF,OAAO,CAAC8B,UAAU,CAACC,YAAY,CAClC,IAAI,CAAC/B,OAAO,CAAC6B,SAAS,EACtB,IAAI,CAAC7B,OACP,CAAC;IACH;IAEA,MAAMgC,YAAY,GAAG,IAAI,CAACC,IAAI,YAAY3C,QAAQ,GAAG,IAAI,CAAC2C,IAAI,GAAG,IAAI;IACrE,MAAMC,cAAc,GAAGF,YAAY,GAAGA,YAAY,CAACd,MAAM,CAAC,CAAC,GAAG,CAAC;IAC/D,MAAMiB,YAAY,GAAG,IAAI,CAACC,IAAI,YAAY9C,QAAQ,GAAG,IAAI,CAAC8C,IAAI,GAAG,IAAI;IACrE;IACA,MAAMC,QAAQ,GAAGF,YAAY,GAAGA,YAAY,CAACG,IAAI,GAAG,EAAE;IACtD,MAAM;MAAEpC;IAAS,CAAC,GAAG,IAAI;IACzB;IACA,MAAMqC,OAAO,GAAGrC,QAAQ,CAACqB,IAAI,CAACiB,KAAK,CAACjD,MAAM,CAACI,QAAQ,CAAC,CAAC8C,IAAI,CAAC,EAAE,CAAC;IAC7DvC,QAAQ,CAACqB,IAAI,GAAGhC,MAAM,CAACI,QAAQ;;IAE/B;IACA;IACA;IACA;IACA,IAAI+C,cAAc;IAClB,IAAIV,YAAY,EAAE;MAChBU,cAAc,GAAGV,YAAY;MAC7B,IAAIO,OAAO,IAAIJ,YAAY,EAAE;QAC3BH,YAAY,CAACW,QAAQ,CAACX,YAAY,CAACd,MAAM,CAAC,CAAC,EAAEqB,OAAO,GAAGF,QAAQ,CAAC;QAChE,IAAIF,YAAY,EAAE;UAChBA,YAAY,CAACX,MAAM,CAAC,CAAC;QACvB;MACF;IACF,CAAC,MAAM,IAAIW,YAAY,EAAE;MACvBO,cAAc,GAAGP,YAAY;MAC7BA,YAAY,CAACQ,QAAQ,CAAC,CAAC,EAAEJ,OAAO,CAAC;IACnC,CAAC,MAAM;MACL,MAAMK,WAAW,GAAGzC,QAAQ,CAACC,cAAc,CAACmC,OAAO,CAAC;MACpDG,cAAc,GAAG,IAAI,CAAC3C,MAAM,CAAC8C,MAAM,CAACD,WAAW,CAAC;MAChD,IAAI,CAACpC,MAAM,CAACuB,YAAY,CAACW,cAAc,EAAE,IAAI,CAAC;IAChD;IAEA,IAAI,CAAClB,MAAM,CAAC,CAAC;IACb,IAAIG,KAAK,EAAE;MACT;MACA,MAAMmB,WAAW,GAAGA,CAACzB,IAAU,EAAEJ,MAAc,KAAK;QAClD,IAAIe,YAAY,IAAIX,IAAI,KAAKW,YAAY,CAAChC,OAAO,EAAE;UACjD,OAAOiB,MAAM;QACf;QACA,IAAII,IAAI,KAAKnB,QAAQ,EAAE;UACrB,OAAOgC,cAAc,GAAGjB,MAAM,GAAG,CAAC;QACpC;QACA,IAAIkB,YAAY,IAAId,IAAI,KAAKc,YAAY,CAACnC,OAAO,EAAE;UACjD,OAAOkC,cAAc,GAAGK,OAAO,CAACrB,MAAM,GAAGD,MAAM;QACjD;QACA,OAAO,IAAI;MACb,CAAC;MAED,MAAM8B,KAAK,GAAGD,WAAW,CAACnB,KAAK,CAACoB,KAAK,CAAC1B,IAAI,EAAEM,KAAK,CAACoB,KAAK,CAAC9B,MAAM,CAAC;MAC/D,MAAM+B,GAAG,GAAGF,WAAW,CAACnB,KAAK,CAACqB,GAAG,CAAC3B,IAAI,EAAEM,KAAK,CAACqB,GAAG,CAAC/B,MAAM,CAAC;MACzD,IAAI8B,KAAK,KAAK,IAAI,IAAIC,GAAG,KAAK,IAAI,EAAE;QAClC,OAAO;UACLC,SAAS,EAAEP,cAAc,CAAC1C,OAAO;UACjCkD,WAAW,EAAEH,KAAK;UAClBI,OAAO,EAAET,cAAc,CAAC1C,OAAO;UAC/BoD,SAAS,EAAEJ;QACb,CAAC;MACH;IACF;IACA,OAAO,IAAI;EACb;EAEAK,MAAMA,CAACC,SAA2B,EAAEC,OAAgC,EAAE;IACpE,IACED,SAAS,CAACE,IAAI,CAAEC,QAAQ,IAAK;MAC3B,OACEA,QAAQ,CAACC,IAAI,KAAK,eAAe,IAAID,QAAQ,CAAC7C,MAAM,KAAK,IAAI,CAACV,QAAQ;IAE1E,CAAC,CAAC,EACF;MACA,MAAMyB,KAAK,GAAG,IAAI,CAACF,OAAO,CAAC,CAAC;MAC5B,IAAIE,KAAK,EAAE4B,OAAO,CAAC5B,KAAK,GAAGA,KAAK;IAClC;EACF;;EAEA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACAR,QAAQA,CAACoC,OAAiB,EAAE;IAC1B;IACA,KAAK,CAACpC,QAAQ,CAACoC,OAAO,CAAC;IAEvB,IAAI;MAAE/C;IAAO,CAAC,GAAG,IAAI;IACrB,OAAOA,MAAM,EAAE;MACb,IAAIA,MAAM,CAACR,OAAO,CAACN,OAAO,KAAK,GAAG,EAAE;QAClC,IAAI,CAACY,WAAW,GAAGf,MAAM,CAACI,QAAQ,CAACuB,MAAM;QACzC;QACAV,MAAM,CAACmD,OAAO,CAAC,IAAI,CAAC1C,MAAM,CAACT,MAAM,CAAC,EAAE,IAAI,CAACU,MAAM,CAAC,CAAC,CAAC,CAAC0C,MAAM,CAAC,CAAC;QAC3D,IAAI,CAACtD,WAAW,GAAG,CAAC;QACpB;MACF;MACAE,MAAM,GAAGA,MAAM,CAACA,MAAM;IACxB;EACF;EAEAZ,KAAKA,CAAA,EAAG;IACN,OAAO,EAAE;EACX;AACF;AAEA,eAAeL,MAAM","ignoreList":[]}