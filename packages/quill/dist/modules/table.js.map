{"version":3,"file":"table.js","names":["Delta","Quill","Module","TableCell","TableRow","TableBody","TableContainer","tableId","Table","register","constructor","arguments","listenBalanceCells","balanceTables","quill","scroll","descendants","forEach","table","balanceCells","deleteColumn","cell","getTable","cellOffset","update","sources","USER","deleteRow","row","remove","deleteTable","offset","setSelection","SILENT","range","length","undefined","getSelection","getLine","index","statics","blotName","parent","insertColumn","column","shift","rowOffset","insertColumnLeft","insertColumnRight","insertRow","children","insertRowAbove","insertRowBelow","insertTable","rows","columns","delta","Array","fill","reduce","memo","text","join","insert","retain","updateContents","on","events","SCROLL_OPTIMIZE","mutations","some","mutation","includes","target","tagName","once","TEXT_CHANGE","old","source"],"sources":["../../src/modules/table.ts"],"sourcesContent":["import Delta from 'quill-delta';\r\nimport Quill from '../core/quill.js';\r\nimport Module from '../core/module.js';\r\nimport {\r\n  TableCell,\r\n  TableRow,\r\n  TableBody,\r\n  TableContainer,\r\n  tableId,\r\n} from '../formats/table.js';\r\n\r\nclass Table extends Module {\r\n  static register() {\r\n    Quill.register(TableCell);\r\n    Quill.register(TableRow);\r\n    Quill.register(TableBody);\r\n    Quill.register(TableContainer);\r\n  }\r\n\r\n  constructor(...args: ConstructorParameters<typeof Module>) {\r\n    super(...args);\r\n    this.listenBalanceCells();\r\n  }\r\n\r\n  balanceTables() {\r\n    this.quill.scroll.descendants(TableContainer).forEach((table) => {\r\n      table.balanceCells();\r\n    });\r\n  }\r\n\r\n  deleteColumn() {\r\n    const [table, , cell] = this.getTable();\r\n    if (cell == null) return;\r\n    // @ts-expect-error\r\n    table.deleteColumn(cell.cellOffset());\r\n    this.quill.update(Quill.sources.USER);\r\n  }\r\n\r\n  deleteRow() {\r\n    const [, row] = this.getTable();\r\n    if (row == null) return;\r\n    row.remove();\r\n    this.quill.update(Quill.sources.USER);\r\n  }\r\n\r\n  deleteTable() {\r\n    const [table] = this.getTable();\r\n    if (table == null) return;\r\n    // @ts-expect-error\r\n    const offset = table.offset();\r\n    // @ts-expect-error\r\n    table.remove();\r\n    this.quill.update(Quill.sources.USER);\r\n    this.quill.setSelection(offset, Quill.sources.SILENT);\r\n  }\r\n\r\n  getTable(\r\n    range = this.quill.getSelection(),\r\n  ): [null, null, null, -1] | [Table, TableRow, TableCell, number] {\r\n    if (range == null) return [null, null, null, -1];\r\n    const [cell, offset] = this.quill.getLine(range.index);\r\n    if (cell == null || cell.statics.blotName !== TableCell.blotName) {\r\n      return [null, null, null, -1];\r\n    }\r\n    const row = cell.parent;\r\n    const table = row.parent.parent;\r\n    // @ts-expect-error\r\n    return [table, row, cell, offset];\r\n  }\r\n\r\n  insertColumn(offset: number) {\r\n    const range = this.quill.getSelection();\r\n    if (!range) return;\r\n    const [table, row, cell] = this.getTable(range);\r\n    if (cell == null) return;\r\n    const column = cell.cellOffset();\r\n    table.insertColumn(column + offset);\r\n    this.quill.update(Quill.sources.USER);\r\n    let shift = row.rowOffset();\r\n    if (offset === 0) {\r\n      shift += 1;\r\n    }\r\n    this.quill.setSelection(\r\n      range.index + shift,\r\n      range.length,\r\n      Quill.sources.SILENT,\r\n    );\r\n  }\r\n\r\n  insertColumnLeft() {\r\n    this.insertColumn(0);\r\n  }\r\n\r\n  insertColumnRight() {\r\n    this.insertColumn(1);\r\n  }\r\n\r\n  insertRow(offset: number) {\r\n    const range = this.quill.getSelection();\r\n    if (!range) return;\r\n    const [table, row, cell] = this.getTable(range);\r\n    if (cell == null) return;\r\n    const index = row.rowOffset();\r\n    table.insertRow(index + offset);\r\n    this.quill.update(Quill.sources.USER);\r\n    if (offset > 0) {\r\n      this.quill.setSelection(range, Quill.sources.SILENT);\r\n    } else {\r\n      this.quill.setSelection(\r\n        range.index + row.children.length,\r\n        range.length,\r\n        Quill.sources.SILENT,\r\n      );\r\n    }\r\n  }\r\n\r\n  insertRowAbove() {\r\n    this.insertRow(0);\r\n  }\r\n\r\n  insertRowBelow() {\r\n    this.insertRow(1);\r\n  }\r\n\r\n  insertTable(rows: number, columns: number) {\r\n    const range = this.quill.getSelection();\r\n    if (range == null) return;\r\n    const delta = new Array(rows).fill(0).reduce((memo) => {\r\n      const text = new Array(columns).fill('\\n').join('');\r\n      return memo.insert(text, { table: tableId() });\r\n    }, new Delta().retain(range.index));\r\n    this.quill.updateContents(delta, Quill.sources.USER);\r\n    this.quill.setSelection(range.index, Quill.sources.SILENT);\r\n    this.balanceTables();\r\n  }\r\n\r\n  listenBalanceCells() {\r\n    this.quill.on(\r\n      Quill.events.SCROLL_OPTIMIZE,\r\n      (mutations: MutationRecord[]) => {\r\n        mutations.some((mutation) => {\r\n          if (\r\n            ['TD', 'TR', 'TBODY', 'TABLE'].includes(\r\n              (mutation.target as HTMLElement).tagName,\r\n            )\r\n          ) {\r\n            this.quill.once(Quill.events.TEXT_CHANGE, (delta, old, source) => {\r\n              if (source !== Quill.sources.USER) return;\r\n              this.balanceTables();\r\n            });\r\n            return true;\r\n          }\r\n          return false;\r\n        });\r\n      },\r\n    );\r\n  }\r\n}\r\n\r\nexport default Table;\r\n"],"mappings":"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","ignoreList":[]}