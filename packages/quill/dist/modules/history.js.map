{"version":3,"file":"history.js","names":["Scope","Module","Quill","History","DEFAULTS","delay","maxStack","userOnly","lastRecorded","ignoreChange","stack","undo","redo","currentRange","constructor","quill","options","on","events","EDITOR_CHANGE","eventName","value","oldValue","source","SELECTION_CHANGE","sources","SILENT","TEXT_CHANGE","USER","record","transform","transformRange","keyboard","addBinding","key","shortKey","bind","shiftKey","test","navigator","platform","root","addEventListener","event","inputType","preventDefault","change","dest","length","item","pop","base","getContents","inverseDelta","delta","invert","push","range","updateContents","restoreSelection","clear","cutoff","changeDelta","oldDelta","ops","undoDelta","undoRange","timestamp","Date","now","compose","shift","transformStack","stackItem","setSelection","index","getLastChangeIndex","scroll","remoteDelta","i","oldItem","splice","endsWithNewlineChange","lastOp","insert","endsWith","attributes","Object","keys","some","attr","query","BLOCK","deleteLength","reduce","op","delete","changeIndex","start","transformPosition","end","default"],"sources":["../../src/modules/history.ts"],"sourcesContent":["import { Scope } from 'parchment';\r\nimport type Delta from 'quill-delta';\r\nimport Module from '../core/module.js';\r\nimport Quill from '../core/quill.js';\r\nimport type Scroll from '../blots/scroll.js';\r\nimport type { Range } from '../core/selection.js';\r\n\r\nexport interface HistoryOptions {\r\n  userOnly: boolean;\r\n  delay: number;\r\n  maxStack: number;\r\n}\r\n\r\nexport interface StackItem {\r\n  delta: Delta;\r\n  range: Range | null;\r\n}\r\n\r\ninterface Stack {\r\n  undo: StackItem[];\r\n  redo: StackItem[];\r\n}\r\n\r\nclass History extends Module<HistoryOptions> {\r\n  static DEFAULTS: HistoryOptions = {\r\n    delay: 1000,\r\n    maxStack: 100,\r\n    userOnly: false,\r\n  };\r\n\r\n  lastRecorded = 0;\r\n  ignoreChange = false;\r\n  stack: Stack = { undo: [], redo: [] };\r\n  currentRange: Range | null = null;\r\n\r\n  constructor(quill: Quill, options: Partial<HistoryOptions>) {\r\n    super(quill, options);\r\n    this.quill.on(\r\n      Quill.events.EDITOR_CHANGE,\r\n      (eventName, value, oldValue, source) => {\r\n        if (eventName === Quill.events.SELECTION_CHANGE) {\r\n          if (value && source !== Quill.sources.SILENT) {\r\n            this.currentRange = value;\r\n          }\r\n        } else if (eventName === Quill.events.TEXT_CHANGE) {\r\n          if (!this.ignoreChange) {\r\n            if (!this.options.userOnly || source === Quill.sources.USER) {\r\n              this.record(value, oldValue);\r\n            } else {\r\n              this.transform(value);\r\n            }\r\n          }\r\n\r\n          this.currentRange = transformRange(this.currentRange, value);\r\n        }\r\n      },\r\n    );\r\n\r\n    this.quill.keyboard.addBinding(\r\n      { key: 'z', shortKey: true },\r\n      this.undo.bind(this),\r\n    );\r\n    this.quill.keyboard.addBinding(\r\n      { key: ['z', 'Z'], shortKey: true, shiftKey: true },\r\n      this.redo.bind(this),\r\n    );\r\n    if (/Win/i.test(navigator.platform)) {\r\n      this.quill.keyboard.addBinding(\r\n        { key: 'y', shortKey: true },\r\n        this.redo.bind(this),\r\n      );\r\n    }\r\n\r\n    this.quill.root.addEventListener('beforeinput', (event) => {\r\n      if (event.inputType === 'historyUndo') {\r\n        this.undo();\r\n        event.preventDefault();\r\n      } else if (event.inputType === 'historyRedo') {\r\n        this.redo();\r\n        event.preventDefault();\r\n      }\r\n    });\r\n  }\r\n\r\n  change(source: 'undo' | 'redo', dest: 'redo' | 'undo') {\r\n    if (this.stack[source].length === 0) return;\r\n    const item = this.stack[source].pop();\r\n    if (!item) return;\r\n    const base = this.quill.getContents();\r\n    const inverseDelta = item.delta.invert(base);\r\n    this.stack[dest].push({\r\n      delta: inverseDelta,\r\n      range: transformRange(item.range, inverseDelta),\r\n    });\r\n    this.lastRecorded = 0;\r\n    this.ignoreChange = true;\r\n    this.quill.updateContents(item.delta, Quill.sources.USER);\r\n    this.ignoreChange = false;\r\n\r\n    this.restoreSelection(item);\r\n  }\r\n\r\n  clear() {\r\n    this.stack = { undo: [], redo: [] };\r\n  }\r\n\r\n  cutoff() {\r\n    this.lastRecorded = 0;\r\n  }\r\n\r\n  record(changeDelta: Delta, oldDelta: Delta) {\r\n    if (changeDelta.ops.length === 0) return;\r\n    this.stack.redo = [];\r\n    let undoDelta = changeDelta.invert(oldDelta);\r\n    let undoRange = this.currentRange;\r\n    const timestamp = Date.now();\r\n    if (\r\n      // @ts-expect-error Fix me later\r\n      this.lastRecorded + this.options.delay > timestamp &&\r\n      this.stack.undo.length > 0\r\n    ) {\r\n      const item = this.stack.undo.pop();\r\n      if (item) {\r\n        undoDelta = undoDelta.compose(item.delta);\r\n        undoRange = item.range;\r\n      }\r\n    } else {\r\n      this.lastRecorded = timestamp;\r\n    }\r\n    if (undoDelta.length() === 0) return;\r\n    this.stack.undo.push({ delta: undoDelta, range: undoRange });\r\n    // @ts-expect-error Fix me later\r\n    if (this.stack.undo.length > this.options.maxStack) {\r\n      this.stack.undo.shift();\r\n    }\r\n  }\r\n\r\n  redo() {\r\n    this.change('redo', 'undo');\r\n  }\r\n\r\n  transform(delta: Delta) {\r\n    transformStack(this.stack.undo, delta);\r\n    transformStack(this.stack.redo, delta);\r\n  }\r\n\r\n  undo() {\r\n    this.change('undo', 'redo');\r\n  }\r\n\r\n  protected restoreSelection(stackItem: StackItem) {\r\n    if (stackItem.range) {\r\n      this.quill.setSelection(stackItem.range, Quill.sources.USER);\r\n    } else {\r\n      const index = getLastChangeIndex(this.quill.scroll, stackItem.delta);\r\n      this.quill.setSelection(index, Quill.sources.USER);\r\n    }\r\n  }\r\n}\r\n\r\nfunction transformStack(stack: StackItem[], delta: Delta) {\r\n  let remoteDelta = delta;\r\n  for (let i = stack.length - 1; i >= 0; i -= 1) {\r\n    const oldItem = stack[i];\r\n    stack[i] = {\r\n      delta: remoteDelta.transform(oldItem.delta, true),\r\n      range: oldItem.range && transformRange(oldItem.range, remoteDelta),\r\n    };\r\n    remoteDelta = oldItem.delta.transform(remoteDelta);\r\n    if (stack[i].delta.length() === 0) {\r\n      stack.splice(i, 1);\r\n    }\r\n  }\r\n}\r\n\r\nfunction endsWithNewlineChange(scroll: Scroll, delta: Delta) {\r\n  const lastOp = delta.ops[delta.ops.length - 1];\r\n  if (lastOp == null) return false;\r\n  if (lastOp.insert != null) {\r\n    return typeof lastOp.insert === 'string' && lastOp.insert.endsWith('\\n');\r\n  }\r\n  if (lastOp.attributes != null) {\r\n    return Object.keys(lastOp.attributes).some((attr) => {\r\n      return scroll.query(attr, Scope.BLOCK) != null;\r\n    });\r\n  }\r\n  return false;\r\n}\r\n\r\nfunction getLastChangeIndex(scroll: Scroll, delta: Delta) {\r\n  const deleteLength = delta.reduce((length, op) => {\r\n    return length + (op.delete || 0);\r\n  }, 0);\r\n  let changeIndex = delta.length() - deleteLength;\r\n  if (endsWithNewlineChange(scroll, delta)) {\r\n    changeIndex -= 1;\r\n  }\r\n  return changeIndex;\r\n}\r\n\r\nfunction transformRange(range: Range | null, delta: Delta) {\r\n  if (!range) return range;\r\n  const start = delta.transformPosition(range.index);\r\n  const end = delta.transformPosition(range.index + range.length);\r\n  return { index: start, length: end - start };\r\n}\r\n\r\nexport { History as default, getLastChangeIndex };\r\n"],"mappings":"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","ignoreList":[]}